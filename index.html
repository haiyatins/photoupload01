<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>馬拉松照片上傳</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .upload-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .file-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .btn-upload {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            width: 100%;
            font-size: 18px;
            margin: 10px 0;
            cursor: pointer;
        }
        #fileList {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-box">
            <h2>馬拉松照片上傳</h2>
            <div class="upload-form">
                <input type="file" id="fileInput" accept="image/*" multiple style="display:none">
                <button type="button" class="btn-upload" onclick="document.getElementById('fileInput').click()">
                    選擇照片
                </button>
            </div>
        </div>
        <div id="fileList"></div>
    </div>

    <script>
        const API_URL = window.location.protocol === 'https:' ? 
            'http://ec2-52-68-196-64.ap-northeast-1.compute.amazonaws.com/upload.v21.php' : 
            'http://ec2-52-68-196-64.ap-northeast-1.compute.amazonaws.com/upload.v21.php';

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            for (let file of files) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.textContent = `${file.name} - 準備上傳`;
                fileList.appendChild(fileItem);

                try {
                    await uploadFileWithForm(file, fileItem);
                } catch (error) {
                    console.error('Upload error:', error);
                    fileItem.textContent = `${file.name} - 已送出`;
                }
            }
        });

        function uploadFileWithForm(file, fileItem) {
            return new Promise((resolve, reject) => {
                const uniqueId = Math.random().toString(36).substring(7);
                const formId = `uploadForm_${uniqueId}`;
                const iframeId = `uploadFrame_${uniqueId}`;

                // 創建表單
                const form = document.createElement('form');
                form.id = formId;
                form.method = 'POST';
                form.enctype = 'multipart/form-data';
                form.action = API_URL;
                form.target = iframeId;
                form.style.display = 'none';

                // 創建 iframe
                const iframe = document.createElement('iframe');
                iframe.name = iframeId;
                iframe.id = iframeId;
                iframe.style.display = 'none';

                // 創建檔案輸入
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.name = 'file';
                
                // 設置檔案
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;

                // 添加參數
                const params = {
                    'para1': 'NDQwMzI3MTQ=',
                    'para2': 'YWU4ZGUxYjA3MmY5NTBmZA==',
                    'para3': 'MTUwNjk=',
                    'para4': 'MjU2NTQ1',
                    'para5': 'MDg=',
                    'p6': '2024台灣米倉田中馬拉松',
                    'p7': '2024-11-10',
                    'p8': '蘇兄 拍攝',
                    'p9': '1731421179047'
                };

                Object.entries(params).forEach(([key, value]) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                });

                // 添加檔案輸入
                form.appendChild(fileInput);

                // 處理上傳完成
                iframe.onload = function() {
                    try {
                        fileItem.textContent = `${file.name} - 已送出`;
                        resolve();
                    } catch (error) {
                        reject(error);
                    } finally {
                        // 清理 DOM
                        setTimeout(() => {
                            document.body.removeChild(form);
                            document.body.removeChild(iframe);
                        }, 1000);
                    }
                };

                // 添加到文檔
                document.body.appendChild(form);
                document.body.appendChild(iframe);

                // 更新狀態
                fileItem.textContent = `${file.name} - 上傳中...`;

                // 提交表單
                form.submit();
            });
        }
    </script>
</body>
</html>
